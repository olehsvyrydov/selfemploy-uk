<?xml version="1.0" encoding="UTF-8"?>

<?import java.lang.String?>
<?import javafx.scene.layout.*?>
<?import javafx.scene.control.*?>
<?import javafx.geometry.Insets?>
<?import javafx.collections.FXCollections?>
<?import org.kordamp.ikonli.javafx.FontIcon?>

<!-- Stylesheets loaded programmatically to avoid JPMS issues -->
<ScrollPane xmlns:fx="http://javafx.com/fxml/1"
            fx:controller="uk.selfemploy.ui.controller.SubmissionHistoryController"
            styleClass="history-scroll"
            fitToWidth="true" hbarPolicy="NEVER">

    <VBox fx:id="historyContainer" styleClass="history-container" spacing="20">
        <padding><Insets top="30" right="30" bottom="30" left="30"/></padding>

        <!-- Page Header -->
        <HBox alignment="CENTER_LEFT" spacing="15">
            <Label text="Submission History" styleClass="page-title"/>
            <Region HBox.hgrow="ALWAYS"/>
            <HBox alignment="CENTER_RIGHT" spacing="12">
                <Label text="Tax Year:" styleClass="filter-label"/>
                <ComboBox fx:id="taxYearFilter" styleClass="filter-dropdown"
                          promptText="All Years" onAction="#handleTaxYearFilter">
                    <items>
                        <FXCollections fx:factory="observableArrayList">
                            <String fx:value="All Years"/>
                            <String fx:value="2025/26"/>
                            <String fx:value="2024/25"/>
                            <String fx:value="2023/24"/>
                        </FXCollections>
                    </items>
                </ComboBox>
                <Button fx:id="refreshBtn" text="Refresh" styleClass="button-secondary"
                        onAction="#handleRefresh"/>
            </HBox>
        </HBox>

        <!-- Summary Stats Row -->
        <HBox fx:id="statsRow" styleClass="stats-row" spacing="16" alignment="CENTER_LEFT">
            <VBox styleClass="stat-item" alignment="CENTER" spacing="4">
                <Label fx:id="totalSubmissionsLabel" text="0" styleClass="stat-value"/>
                <Label text="Total Submissions" styleClass="stat-label"/>
            </VBox>
            <Separator orientation="VERTICAL" styleClass="stat-separator"/>
            <VBox styleClass="stat-item" alignment="CENTER" spacing="4">
                <Label fx:id="acceptedCountLabel" text="0" styleClass="stat-value, stat-accepted"/>
                <Label text="Accepted" styleClass="stat-label"/>
            </VBox>
            <Separator orientation="VERTICAL" styleClass="stat-separator"/>
            <VBox styleClass="stat-item" alignment="CENTER" spacing="4">
                <Label fx:id="pendingCountLabel" text="0" styleClass="stat-value, stat-pending"/>
                <Label text="Pending" styleClass="stat-label"/>
            </VBox>
            <Separator orientation="VERTICAL" styleClass="stat-separator"/>
            <VBox styleClass="stat-item" alignment="CENTER" spacing="4">
                <Label fx:id="rejectedCountLabel" text="0" styleClass="stat-value, stat-rejected"/>
                <Label text="Rejected" styleClass="stat-label"/>
            </VBox>
        </HBox>

        <!-- Loading State (shown while fetching from SQLite) -->
        <VBox fx:id="loadingState" alignment="CENTER" spacing="12"
              managed="false" visible="false">
            <padding><Insets topRightBottomLeft="40"/></padding>
            <ProgressIndicator fx:id="loadingIndicator" prefWidth="40" prefHeight="40"/>
            <Label text="Loading submissions..." styleClass="loading-text"/>
        </VBox>

        <!-- Submissions List Container -->
        <VBox fx:id="submissionsList" styleClass="submissions-list" spacing="12">
            <!-- Dynamic content - submission cards populated by controller -->
        </VBox>

        <!-- Empty State (shown when no submissions) - using Ikonli icons -->
        <VBox fx:id="emptyState" styleClass="empty-state-container" alignment="CENTER"
              spacing="16" managed="false" visible="false">
            <!-- Document Icon - using Ikonli FontAwesome5 -->
            <FontIcon iconLiteral="fas-inbox" iconSize="48" styleClass="empty-state-icon"/>
            <Label text="No Submissions Yet" styleClass="empty-state-title"/>
            <Label text="Your HMRC submission history will appear here once you submit your first quarterly or annual return."
                   styleClass="empty-state-message" wrapText="true" textAlignment="CENTER"/>

            <!-- Info Box explaining prerequisites - using Ikonli -->
            <HBox fx:id="infoBox" styleClass="info-box" spacing="12" alignment="CENTER_LEFT" maxWidth="400">
                <FontIcon iconLiteral="fas-info-circle" iconSize="16" styleClass="info-icon"/>
                <VBox spacing="4">
                    <Label text="Getting Started" styleClass="info-title"/>
                    <Label fx:id="infoBoxMessage"
                           text="To submit returns, first connect to HMRC from the HMRC Submission page."
                           styleClass="info-text" wrapText="true"/>
                </VBox>
            </HBox>

            <!-- Primary action button - navigates to HMRC Submission -->
            <Button fx:id="goToHmrcBtn" text="Go to HMRC Submission" styleClass="button-primary"
                    onAction="#handleGoToHmrcSubmission"
                    accessibleText="Navigate to HMRC Submission page to connect your account"/>
        </VBox>

        <!-- Detail Panel (shown when a submission is selected) -->
        <VBox fx:id="detailPanel" styleClass="detail-panel" spacing="20"
              managed="false" visible="false">
            <padding><Insets topRightBottomLeft="24"/></padding>

            <!-- Detail Header -->
            <HBox alignment="CENTER_LEFT" spacing="12">
                <Button fx:id="backBtn" text="Back" styleClass="back-button" onAction="#handleBack"/>
                <Label text="Submission Details" styleClass="panel-title"/>
                <Region HBox.hgrow="ALWAYS"/>
                <Label fx:id="detailTypeBadge" text="Annual" styleClass="type-badge, type-annual"/>
            </HBox>

            <!-- Status Card -->
            <VBox fx:id="statusCard" styleClass="detail-status-card, status-accepted" spacing="8">
                <HBox alignment="CENTER_LEFT" spacing="8">
                    <Label fx:id="detailStatusIcon" text="[check]" styleClass="detail-status-icon"/>
                    <Label fx:id="detailStatusText" text="Accepted" styleClass="detail-status-text"/>
                </HBox>
                <Label fx:id="detailStatusDate" text="Accepted on 24 Jan 2026 at 14:35"
                       styleClass="detail-status-date"/>
            </VBox>

            <!-- Reference Section -->
            <VBox styleClass="detail-section" spacing="8">
                <Label text="HMRC Reference" styleClass="detail-section-label"/>
                <HBox alignment="CENTER_LEFT" spacing="8">
                    <Label fx:id="detailReference" text="SA-2025-123456789" styleClass="detail-reference"/>
                    <Button text="Copy" styleClass="copy-button" onAction="#handleCopyReference"/>
                </HBox>
            </VBox>

            <!-- Key Information Grid -->
            <VBox styleClass="detail-section" spacing="12">
                <Label text="Submission Summary" styleClass="detail-section-label"/>

                <GridPane styleClass="detail-grid" hgap="16" vgap="8">
                    <Label text="Tax Year:" styleClass="grid-label" GridPane.rowIndex="0" GridPane.columnIndex="0"/>
                    <Label fx:id="detailTaxYear" text="2025/26" styleClass="grid-value"
                           GridPane.rowIndex="0" GridPane.columnIndex="1"/>

                    <Label text="Submission Type:" styleClass="grid-label" GridPane.rowIndex="1" GridPane.columnIndex="0"/>
                    <Label fx:id="detailType" text="Annual Self Assessment" styleClass="grid-value"
                           GridPane.rowIndex="1" GridPane.columnIndex="1"/>

                    <Label text="Submitted:" styleClass="grid-label" GridPane.rowIndex="2" GridPane.columnIndex="0"/>
                    <Label fx:id="detailSubmitted" text="24 Jan 2026 14:32:15" styleClass="grid-value"
                           GridPane.rowIndex="2" GridPane.columnIndex="1"/>
                </GridPane>
            </VBox>

            <!-- Financial Summary -->
            <VBox styleClass="detail-section" spacing="12">
                <Label text="Financial Summary" styleClass="detail-section-label"/>

                <VBox styleClass="financial-summary-card" spacing="8">
                    <HBox alignment="CENTER_LEFT">
                        <Label text="Total Income" styleClass="summary-label"/>
                        <Region HBox.hgrow="ALWAYS"/>
                        <Label fx:id="detailIncome" text="£45,000.00" styleClass="summary-value, income"/>
                    </HBox>
                    <HBox alignment="CENTER_LEFT">
                        <Label text="Total Expenses" styleClass="summary-label"/>
                        <Region HBox.hgrow="ALWAYS"/>
                        <Label fx:id="detailExpenses" text="£13,000.00" styleClass="summary-value, expense"/>
                    </HBox>
                    <Separator/>
                    <HBox alignment="CENTER_LEFT">
                        <Label text="Net Profit" styleClass="summary-label, bold"/>
                        <Region HBox.hgrow="ALWAYS"/>
                        <Label fx:id="detailProfit" text="£32,000.00" styleClass="summary-value, profit"/>
                    </HBox>
                    <HBox alignment="CENTER_LEFT">
                        <Label text="Tax Due" styleClass="summary-label, bold"/>
                        <Region HBox.hgrow="ALWAYS"/>
                        <Label fx:id="detailTaxDue" text="£5,051.80" styleClass="summary-value, tax"/>
                    </HBox>
                </VBox>
            </VBox>

            <!-- Error Message (only for rejected submissions) - using Ikonli icons -->
            <VBox fx:id="errorSection" styleClass="error-section" spacing="12"
                  managed="false" visible="false">
                <Label text="Error Details" styleClass="detail-section-label"/>
                <HBox styleClass="error-box" alignment="CENTER_LEFT" spacing="8">
                    <FontIcon iconLiteral="fas-exclamation-triangle" iconSize="14" styleClass="error-icon"/>
                    <Label fx:id="detailErrorMessage" text="Invalid calculation reference"
                           styleClass="error-text" wrapText="true"/>
                </HBox>

                <!-- Error Resolution Guidance - using Ikonli -->
                <VBox fx:id="errorGuidanceBox" styleClass="error-guidance-box" spacing="8"
                      managed="true" visible="true">
                    <HBox alignment="CENTER_LEFT" spacing="8">
                        <FontIcon iconLiteral="fas-lightbulb" iconSize="14" styleClass="guidance-icon"/>
                        <Label text="How to resolve this" styleClass="guidance-title"/>
                    </HBox>
                    <Label fx:id="errorGuidanceText"
                           text="Check your submission details and try again."
                           styleClass="guidance-text" wrapText="true"/>
                    <Hyperlink fx:id="learnMoreLink" text="Learn more on GOV.UK"
                               styleClass="guidance-link" onAction="#handleLearnMore"
                               accessibleText="Open HMRC guidance on Self Assessment corrections"/>
                </VBox>

                <Button fx:id="retryBtn" text="Retry Submission" styleClass="button-warning"
                        onAction="#handleRetry" disable="true"/>
            </VBox>

            <!-- Actions -->
            <HBox alignment="CENTER" spacing="12">
                <Button fx:id="downloadPdfBtn" text="Download PDF" styleClass="button-secondary"
                        onAction="#handleDownloadPDF"
                        accessibleText="Download PDF confirmation for this submission"/>
            </HBox>
        </VBox>

    </VBox>
</ScrollPane>
